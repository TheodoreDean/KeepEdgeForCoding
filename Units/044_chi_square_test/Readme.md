###   Chi-square test 

#### Reference link

[https://online.stat.psu.edu/stat415/lesson/17/17.1]
```

Input:
Vectors (w_11,w_21,...,w_h1),(w_21,w_22,...,w_h2),...,(w_1n,w_2n,...,w_hn)∈〖{0,...,s-1}〗^h
Test value:
The value f_i [t] = |{j∈¯(1,n)} | w_ij=t|,i=1,2,...,h,t∈{0,1,2,..,s-1} counts number of occurrences of t in (w_i1,w_i2,...,w_in), and denotes
p_t=(f_1 [t]+f_2 [t]+...+f_h [t])/(h∙n),t∈{0,1,2,...,s-1}
the relative frequency for t within all samples. The test value T_7 (h,s) is defined as 
T_7 (h,s)=∑_(i=1...h)▒∑_(t=0,...,s-1)▒〖〖(f_i [t]-np_t)〗^2/np_t 〗
Evaluation rule:
The test fails if T_7 (h,s)>χ^2 (α,(h-1)(s-1)) , where χ^2 (α,(h-1)(s-1) is the rejection bound for a χ^2-test with (h-1)(s-1) degree of freedom at significance level .


```





#### Details example


#### original requirements

> Test T7 (comparative test for multinomial distributions aka ‘test for homogeneity’)

```

```


#### Define
```
定义参数：

α：显著性水平。AIS 20/31 固定为 α = 0.0001。这是一个极其严格的值，意味着期望的误报率（即本身无故障但测试失败的概率）仅为0.01%。

k：随机数取值的可能个数（分类数）。例如，如果测试DRNG输出的单个字节，则 k = 256（值从0到255）。

n：一个测试区间内的样本数量（即一个区间包含多少个随机数）。标准规定 n = 250000。

执行单个区间测试：

收集一个区间的 n = 250,000 个随机数。

计算每个可能值（0到255）实际出现的次数（观察频数 O_i）。

计算每个值的期望频数 E_i。在均匀分布的假设下，E_i = n / k = 250000 / 256 ≈ 976.56。

计算卡方统计量： χ² = Σ [ (O_i - E_i)² / E_i ]，求和范围是 i = 1 到 k。

判断单个区间是否通过：

计算出的 χ² 统计量会与一个临界值进行比较。

这个临界值由显著性水平 α 和自由度 df = k - 1 = 255 决定。

如果 χ² < 临界值，则该区间通过测试。

如果 χ² >= 临界值，则该区间未通过测试，表明该区间的数据分布与均匀分布存在显著偏差。
总体判断（使用二项分布）：

DRNG的测试不会只基于一个区间。标准要求连续测试 N = 1250 个这样的区间。

由于每个区间测试的误报概率 p = α = 0.0001，那么在1250次独立测试中，失败区间的数量应服从二项分布。

根据二项分布计算出一个可接受的失败次数上限。如果失败区间的数量超过了这个上限，则整个DRNG测试失败。


```

#### actual example

```

假设我们评估的不是一个完整的字节（256种值），而是一个2比特的随机数生成器（RNG），其输出只有4种可能：00, 01, 10, 11（对应整数值0, 1, 2, 3）。我们希望它的输出是均匀分布的。

根据BSI AIS 20/31的精神，我们设定参数：

显著性水平 α = 0.0001 (0.01%)

分类数 k = 4

单个测试区间的样本量 n = 1,000,000（为了计算方便，此处不使用25万）

总测试区间数 N = 1250

第一步：对一个测试区间进行卡方检验
1. 收集数据：
我们的RNG生成了1,000,000个2比特的数字。我们统计每个值出现的次数（观察频数 O_i）。

| 值 | 观察频数 (O_i) |
|：--|：-------------|
| 0 | 250,500 |
| 1 | 249,200 |
| 2 | 250,100 |
| 3 | 250,200 |
| 总计 | 1,000,000 |

2. 计算期望频数 (E_i)：
在完美的均匀分布下，每个值出现的期望次数是：
E_i = n / k = 1,000,000 / 4 = 250,000

| 值 | 期望频数 (E_i) |
|：--|：-------------|
| 0 | 250,000 |
| 1 | 250,000 |
| 2 | 250,000 |
| 3 | 250,000 |

3. 计算卡方统计量 (χ²)：
使用公式：χ² = Σ [ (O_i - E_i)² / E_i ]

(250500 - 250000)² / 250000 = (500)² / 250000 = 250000 / 250000 = 1.0

(249200 - 250000)² / 250000 = (-800)² / 250000 = 640000 / 250000 = 2.56

(250100 - 250000)² / 250000 = (100)² / 250000 = 10000 / 250000 = 0.04

(250200 - 250000)² / 250000 = (200)² / 250000 = 40000 / 250000 = 0.16

χ² = 1.0 + 2.56 + 0.04 + 0.16 = 3.76


4. 判断该区间是否通过：

自由度 df = k - 1 = 3

查卡方分布表，在显著性水平 α = 0.0001 和 df = 3 下的临界值约为 21.11。

比较：计算出的 χ² (3.76) < 临界值 (21.11)

结论：这个测试区间通过了卡方检验。

第二步：进行总共N=1250个区间的测试
BSI AIS 20/31的要求不是测一个区间就行，而是要连续测试1250个区间。

1. 收集结果：
假设我们连续测试了1250个区间。由于我们的RNG质量很好，绝大多数区间都通过了测试（即 χ² < 21.11），但其中有1个区间因为某种偶然的波动，计算出的 χ² = 22.5，超过了临界值21.11，因此这个区间测试失败。

2. 使用二项分布进行总体评估：

总测试区间数 N = 1250

每个区间测试失败的理论概率 p = α = 0.0001

期望的失败区间数量为：N * p = 1250 * 0.0001 = 0.125

这意味着，在1250次测试中，平均期望的失败次数大约是0.125次。

现在，我们需要根据二项分布来判断，在1250次测试中出现 1次 失败，是否在可接受的范围内。

BSI标准根据二项分布的计算，设定了一个实际的容忍上限。简单来说，出现少量失败是允许的，只要不超过这个上限。

3. 最终判断：

我们的测试结果：失败次数 = 1

期望的失败次数：~0.125

虽然出现了1次失败，但这个数字非常接近期望值，并且远低于标准根据二项分布计算出的容忍上限（对于N=1250, p=0.0001，容忍上限可能是2或3次）。

结论： 由于1250个区间中只有1个失败，这个数量符合随机波动的预期，因此该随机数生成器通过了BSI AIS 20/31的卡方检验。


```
